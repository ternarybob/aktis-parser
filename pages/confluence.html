<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confluence Data - Aktis Parser</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/common.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    <style>
        .action-button {
            background: #27ae60;
        }

        .action-button:hover {
            background: #1e8449;
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }

        .section-header {
            border-left-color: #27ae60;
        }

        .navbar-link.active {
            border-bottom-color: #27ae60;
        }
    </style>
</head>
<body>
    <!-- Top Navbar -->
    <nav class="navbar">
        <a href="/" class="navbar-brand">
            <div class="navbar-brand-title">AKTIS PARSER</div>
            <div class="navbar-brand-subtitle">DATA COLLECTION SERVICE</div>
        </a>
        <div class="navbar-menu">
            <a href="/" class="navbar-link">HOME</a>
            <a href="/jira" class="navbar-link">JIRA DATA</a>
            <a href="/confluence" class="navbar-link active">CONFLUENCE DATA</a>
        </div>
        <div class="navbar-status">
            <div class="status-indicator"></div>
            <span class="status-text">ONLINE</span>
        </div>
    </nav>

    <div class="main-container">
        <!-- Content Area (60%) -->
        <div class="content-area">
            <!-- Hero Section -->
            <div class="hero-section">
                <h1 class="hero-title">Confluence Data Management</h1>
                <p class="hero-subtitle">
                    Scrape and manage Confluence spaces and pages from authenticated Atlassian instance
                </p>
            </div>

            <!-- Confluence Management Section -->
            <div class="dashboard-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Confluence Spaces</div>
                    </div>

                    <!-- Capture Action -->
                    <div style="padding: 20px; text-align: center;">
                        <p style="font-family: monospace; font-size: 12px; color: #6a6a6a; margin-bottom: 20px;">
                            Scrape Confluence spaces and pages from authenticated Atlassian instance
                        </p>
                        <button id="btn-capture-spaces" class="btn btn-primary" onclick="captureSpaces()">
                            CAPTURE SPACES
                        </button>
                    </div>
                </div>

                <!-- Pages Display Section -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Pages</div>
                        <div class="section-count" id="pages-count" style="font-family: monospace; font-size: 11px; color: #6a6a6a;">Loading...</div>
                    </div>
                    <div class="json-container">
                        <pre><code id="pages-data" class="language-json">Loading...</code></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel (40%) - Service Logs -->
        <div class="right-panel">
            <div class="terminal-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div class="terminal-header" style="margin-bottom: 0;">Service Logs</div>
                    <button class="btn-clear-logs" onclick="clearServiceLogs()">Clear</button>
                </div>
                <div id="service-logs" class="service-logs-container"></div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="system-footer">
        Aktis Parser // Confluence Data Management
    </div>

    <script>
        // WebSocket connection for service logs
        let ws;
        let reconnectInterval;
        let displayedLogs = new Set();

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                console.log('WebSocket connected');
                updateSystemStatus(true);
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };

            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                if (message.type === 'log') {
                    handleLogMessage(message.payload);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateSystemStatus(false);
            };

            ws.onclose = function() {
                console.log('WebSocket disconnected');
                updateSystemStatus(false);
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(connectWebSocket, 3000);
                }
            };
        }

        function updateSystemStatus(online) {
            const statusIndicator = document.querySelector('.status-indicator');
            const statusText = document.querySelector('.status-text');

            if (online) {
                statusIndicator.style.background = '#00cc00';
                statusText.style.color = '#00cc00';
                statusText.textContent = 'ONLINE';
            } else {
                statusIndicator.style.background = '#cc0000';
                statusText.style.color = '#cc0000';
                statusText.textContent = 'OFFLINE';
            }
        }

        function handleLogMessage(logData) {
            const logsContainer = document.getElementById('service-logs');
            if (!logsContainer) return;

            const logLine = `${logData.timestamp}|${logData.level}|${logData.message}`;

            if (displayedLogs.has(logLine)) return;
            displayedLogs.add(logLine);

            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';

            const timestamp = logData.timestamp || new Date().toLocaleTimeString('en-US', { hour12: false });
            const level = logData.level || 'info';
            const message = logData.message || '';

            let levelClass = 'log-level-info';
            let levelText = 'INFO';
            if (level.toLowerCase() === 'error') {
                levelClass = 'log-level-error';
                levelText = 'ERROR';
            } else if (level.toLowerCase() === 'warn') {
                levelClass = 'log-level-warn';
                levelText = 'WARN';
            } else if (level.toLowerCase() === 'debug') {
                levelClass = 'log-level-debug';
                levelText = 'DEBUG';
            }

            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="${levelClass}">[${levelText}]</span>
                <span class="log-message">${escapeHtml(message)}</span>
            `;

            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;

            // Limit to last 100 entries
            while (logsContainer.children.length > 100) {
                const removed = logsContainer.removeChild(logsContainer.firstChild);
                displayedLogs.delete(removed.textContent);
            }
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function clearServiceLogs() {
            const logsContainer = document.getElementById('service-logs');
            if (logsContainer) {
                logsContainer.innerHTML = '';
                displayedLogs.clear();
            }
        }

        // Fetch Confluence data and display
        async function loadConfluenceData() {
            try {
                const response = await fetch('/api/data/confluence');
                if (!response.ok) {
                    throw new Error('Failed to fetch Confluence data');
                }

                const data = await response.json();

                // Display pages
                const pagesCount = data.pages ? data.pages.length : 0;
                document.getElementById('pages-count').textContent = `${pagesCount} page(s)`;

                const pagesData = document.getElementById('pages-data');
                if (pagesCount > 0) {
                    pagesData.textContent = JSON.stringify(data.pages, null, 2);
                } else {
                    pagesData.textContent = 'No pages found in database';
                }

                // Apply syntax highlighting
                document.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });

            } catch (error) {
                console.error('Error loading Confluence data:', error);
                document.getElementById('pages-data').textContent = 'Error loading data: ' + error.message;
            }
        }

        // Capture spaces handler
        async function captureSpaces() {
            const button = document.getElementById('btn-capture-spaces');
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Collecting...';

            try {
                const response = await fetch('/api/scrape/spaces', {
                    method: 'POST'
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Failed to start spaces scraping');
                }

                // Reload data after short delay
                setTimeout(() => {
                    loadConfluenceData();
                }, 2000);

            } catch (error) {
                console.error('Error starting spaces scrape:', error);
                alert('Error: ' + error.message);
            } finally {
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = originalText;
                }, 2000);
            }
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            connectWebSocket();
            loadConfluenceData();
        });
    </script>
</body>
</html>
